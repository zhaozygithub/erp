<!DOCTYPE html>
<html>
<head>
<style>
	.echart-box{
	height: 400px;
	 width: 40%; 
	 float: left;
	}
	.echart-box:last-child,.echart-box:nth-child(2){
	margin-left: 4%;
	}
	.select-box1,.select-box2,.select-box3{
	position: fixed;
	}
	.select-box1{
	top: 24px;
	left: 51%;
	}
	.select-box2{
	top: 424px;
	left: 8%;
	}
	.select-box3{
	top: 424px;
	left: 49%;
	}
	
	.table>tbody>tr>td{
	height:76px !important;
	line-height:76px  !important;
	padding:0  !important;
}
table:first-child tr:first-child td{
	height:30px !important;
	line-height:30px  !important;
	padding:0  !important;
}
	
	</style>
<meta charset="UTF-8">
<title>index echarts</title>
</head>
<body>
 #@jquery()
 #@echarts()
 #@bootstrap()
  <!-- <div >
    <label>订单审批流程</label><br>
    #for(flow:flowlist)
        #for(x:flow)
         #(x.key)
             #for(node:x.value)
                #(node.node_name)
             #end
             
         #end
    #end
    </div> -->
	<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
	<div>
		<div class="echart-box" id="pie"></div>
		<div class="echart-box" id="bar"></div>
		<div class="echart-box" id="barMd"></div>
		<div class="echart-box" id="barWy"></div>
	</div>

	<script type="text/javascript">
	
	$(function(){
        // 基于准备好的dom，初始化echarts图表
        var myChart = echarts.init($("#pie")[0],"infographic"); 
        
        option = {
        	    title : {
        	        text: '实时客户统计',
        	        x:'center'
        	    },
        	    tooltip : {
        	        trigger: 'item',
        	        formatter: "{a} <br/>{b} : {c} ({d}%)"
        	    },
        	    legend: {
        	        orient : 'vertical',
        	        x : 'left',
        	        data:[
        	              #for(x:pie)
        	              '#(x.key)',
        	              #end
        	              
        	             ]
        	    },
        	    toolbox: {
        	        show : true,
        	        feature : {
        	            mark : {show: true},
        	            dataView : {show: true, readOnly: false},
        	            magicType : {
        	                show: true, 
        	                type: ['pie', 'funnel'],
        	                option: {
        	                    funnel: {
        	                        x: '25%',
        	                        width: '50%',
        	                        funnelAlign: 'left',
        	                        max: 1548
        	                    }
        	                }
        	            },
        	            restore : {show: true},
        	            saveAsImage : {show: true}
        	        }
        	    },
        	    calculable : true,
        	    series : [
        	        {
        	            name:'客户统计',
        	            type:'pie',
        	            radius : '55%',
        	            center: ['50%', '60%'],
        	            data:[
        	                #for(x:pie)
        	                {value:#(x.value), name:'#(x.key)'},
        	                #end
        	            ]
        	        }
        	    ]
        	};

        // 为echarts对象加载数据 
        myChart.setOption(option);
        
       var bar=echarts.init($("#bar")[0],"infographic");
        bar.setOption({
       	 
       	 title : {
       	        text: '年度借款数据',
       	       // subtext: '纯属虚构'
       	    },
       	    tooltip : {
       	        trigger: 'axis'
       	    },
       	    legend: {
       	        data:['成交笔数','借款总额']
       	    },
       	    toolbox: {
       	        show : true,
       	        feature : {
       	            mark : {show: true},
       	            dataView : {
       	            	show: true, 
       	            	readOnly: false,
       	            	optionToContent: function (opt) {
         	            	var axisData = opt.xAxis[0].data;
                            var series = opt.series;
                            console.log(axisData);
                            
                            var table = '<table class="table table-bordered text-center"><tbody>';
                            table += '<tr><td></td>'
                            for (var i = 0; i < 12; i++) {
                            	 table +='<td>'+axisData[i]+'</td>'
                            }
                            table +='</tr><tr><td>成交笔数</td>';
                            
                            
                             for (var i = 0; i < 12; i++) {
                                table += '<td>' + series[0].data[i] + '</td>';
                            }
                             
                            table +='</tr><tr><td>借款总额</td>';
                            
                            
                             for (var i = 0; i < 12; i++) {
                                table += '<td>' + series[1].data[i] + '</td>';
                            }
                             
                            table += '</tr></tbody></table>';
                            return table;
       	            	}
       	            },
       	            magicType : {show: true, type: ['line', 'bar']},
       	            restore : {show: true},
       	            saveAsImage : {show: true}
       	        }
       	    },
       	    calculable : true,
       	    xAxis : [
       	        {
       	            type : 'category',
       	            data : ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
       	        }
       	    ],
       	    yAxis : [
       	        {
       	            type : 'value'
       	        }
       	    ],
       	    series : [
       	           #for(x:bar ??)   
       	        {
       	            name:'#(x.key)',
       	            type:'bar',
       	            data:[
       	                  #for(data:x.value)
       	                  #(data),
       	                  #end
       	                  ]
       	            
       	        },
       	        #end
       	    ]
       	
       });
        
     // 文件下载
        jQuery.download = function(url,filedir){
            jQuery('<form action="'+url+'" method="post">' +  // action请求路径及推送方法
                        '<input type="text" name="path" value="'+filedir+'"/>' + // 文件路径
                        //'<input type="text" name="filename" value="'+filename+'"/>' + // 文件名称
                    '</form>')
            .appendTo('body').submit().remove();
        };
        
        
        var barMd=echarts.init($("#barMd")[0],"infographic");
        barMd.setOption({
       	 
       	 title : {
       	        text: '机构年度数据',
       	       // subtext: '纯属虚构'
       	    },
       	    tooltip : {
       	        trigger: 'axis',
       	     axisPointer : {            // 坐标轴指示器，坐标轴触发有效
                 type : 'shadow'       // 默认为直线，可选为：'line' | 'shadow'
             }
       	    },
       	   // legend: {
       	   //     data:['成交笔数','借款总额']
       	   // },
       	    toolbox: {
       	        show : true,
       	        feature : {
       	            mark : {show: true},
       	            dataView : {show: true, readOnly: false,
       	            	optionToContent: function (opt) {
       	            	  var axisData = opt.xAxis[0].data;
                          var series = opt.series;
                          var table = '<table style="width:100%;text-align:center"><tbody><tr>'
                                       + '<th>门店名字</th>'
                                       + '<th>销售总额</th>'
                                      // + '<td>' + series[1].name + '</td>'
                                       + '</tr>';
                          for (var i = 0, l = axisData.length; i < l; i++) {
                              table += '<tr>'
                                       + '<td>' + axisData[i] + '</td>'
                                       + '<td>' + series[0].data[i] + '</td>'
                                       //+ '<td>' + series[1].data[i] + '</td>'
                                       + '</tr>';
                          }
                          table += '</tbody></table>';
                          return table;
       	            		
       	            	}
       	            },
       	            magicType : {show: true, type: ['line', 'bar']},
       	            restore : {show: true},
       	            selfButtons:{//自定义按钮 danielinbiti,这里增加，selfbuttons可以随便取名字    
                     show:true,//是否显示    
                     title:'导出', //鼠标移动上去显示的文字    
                     icon:'images/excel.png', //图标    
                     option:{},    
                     onclick:function(opt) {//点击事件,这里的option1是chart的option信息    
                    	 var year=$("#barMds").children('option:selected').val();
                    	 $.ajax({
                             type : 'POST',
                             dataType : 'json',
                             async : false,
                             url : "/file/exportData", // 生成文件，保存在服务器
                             data : {'data':year},
                             success : function(data) {
                                var result = data["success"];
                                 if (result == "true") {
                                     
                                     $.download('/file',data["path"]); // 下载文件
                                 } else {
                                     alert("数据导出失败！");
                                 } 
                             },
                             error : function(XMLHttpRequest, textStatus, e) {
                                 console.log("oilDetection.js  method exportOilDetection" + e);
                             }
                     });
                           
                           
                           }    
                      },
                       
       	            saveAsImage : {show: true}
       	        }
       	    },
       	    calculable : true,
       	    xAxis : [
       	        {
       	            type : 'category',
       	        axisLabel:{
                     interval:0,
                     rotate:45,
                     margin:2,
                     textStyle:{
                     color:"#222"
                   }
               },
       	            data : [
       	                 #for(x:barMd)
       	                    '#(x.key)',
       	                  #end  
       	                    ]
       	        }
       	    ],
       	    yAxis : [
       	        {
       	            type : 'value'
       	        }
       	    ],
       	    series : [
       	        {
       	            type:'bar',
       	            data:[ #for(x:barMd) 
       	                  #(x.value),
       	                  #end
       	                  ]
       	        }
       	        
       	    ]
       	
       });
        
        
        $("#barMds").change(function(){
    		var select=$(this).children('option:selected').val();
    		$.ajax({
    			   type: "POST",
    			   url: "/getDataByYearMonth",
    			   data: "year="+select,
    			   success: function(msg){
			       debugger;
    			   var obj=$.parseJSON(msg);
    			   var option = barMd.getOption();
    			   var count=0
   				   
    			   for (x in obj){
    				   if(obj.hasOwnProperty(x)){ 
			           //option.series[count].name = x;   
			           option.series[0].data[count] = obj[x];   
    	        	   count++;  
    	        	   } 
    			
    			   } 
			      barMd.setOption(option);
    				   
    			   }
    		});
        	
        });
        
        
        
        
        
        var barWy=echarts.init($("#barWy")[0],"infographic");
        barWy.setOption({
       	 
       	 title : {
       	        text: '违约统计',
       	       // subtext: '纯属虚构'
       	    },
       	    tooltip : {
       	        trigger: 'axis'
       	    },
       	    toolbox: {
       	        show : true,
       	        feature : {
       	            mark : {show: true},
       	            dataView : {show: true, readOnly: false},
       	            magicType : {show: true, type: ['line', 'bar']},
       	            restore : {show: true},
       	            saveAsImage : {show: true}
       	        }
       	    },
       	    calculable : true,
       	    xAxis : [
       	        {
       	            type : 'category',
       	            data : ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
       	        }
       	    ],
       	    yAxis : [
       	        {
       	            type : 'value'
       	        }
       	    ],
       	    series : [
       	            
       	        {
       	            name:'违约',
       	            type:'bar',
       	            data:[1,2,5,4,1,5,2,6,5,7,6,3
       	                  
       	                  ]
       	            
       	        },
       	       
       	    ]
       	
       });
        
        
        
        $("#year").change(function(){
    		var select=$(this).children('option:selected').val();
    		$.ajax({
    		
    			   type: "POST",
    			   url: "/initBarByYear",
    			   data: "year="+select,
    			   success: function(msg){
    			   var obj=$.parseJSON(msg);
   				   //更新数据
			      var option = bar.getOption();
			      option.series[0].data = obj["借款总额"];   
			      option.series[1].data = obj["成交笔数"];   
			      bar.setOption(option); 
    				   
    			   }
    		});
        	
        });
        
        
        
       
        
	
	});
        
        
        
       
    </script>

		<select class="select-box1" id="year"> #for(year:years)
			<option value="#(year)">#(year)</option> #end
		</select>
	
		<select class="select-box2" id="barMds"> #for(year:years_month ??)
			<option value="#(year)">#(year)</option> #end
		</select>
	
		<select class="select-box3" id="barWys"> #for(year:years)
			<option value="#(year)">#(year)</option> #end
		</select>
	
</body>
</html>